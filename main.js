/* Format Clipboard to Canvas - Obsidian Plugin */
"use strict";var M=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var K=(u,l)=>{for(var t in l)M(u,t,{get:l[t],enumerable:!0})},W=(u,l,t,n)=>{if(l&&typeof l=="object"||typeof l=="function")for(let a of j(l))!B.call(u,a)&&a!==t&&M(u,a,{get:()=>l[a],enumerable:!(n=U(l,a))||n.enumerable});return u};var Y=u=>W(M({},"__esModule",{value:!0}),u);var Q={};K(Q,{default:()=>S});module.exports=Y(Q);var N=require("obsidian");var G=require("obsidian"),$={"command-paste-name":"Paste Markdown as Canvas Mindmap","command-copy-name":"Copy Canvas Mindmap as Markdown","setting-title":"Canvas Mindmap Converter Settings","setting-separator-name":"Separator","setting-separator-desc":"Separator to split clipboard content into multiple nodes. Supports \\n (newline), \\n\\n (double newline), \\t, etc. Example: \\n\\n or ---","notice-open-canvas":"Please open a Canvas first.","notice-not-canvas":"Current view is not a Canvas, please open a Canvas before running this command.","notice-read-fail":"Unable to read clipboard, please check permissions.","notice-empty-clipboard":"Clipboard is empty or contains only whitespace.","notice-parse-fail":"Failed to parse valid hierarchical content from clipboard.","notice-create-success":"Created {0} nodes and established {1} connections in Canvas.","notice-create-fail":"Failed to create Canvas nodes, check console for details.","notice-no-nodes":"Canvas has no nodes.","notice-select-at-least-one":"Please select at least one node.","notice-export-success":"Exported {0} nodes to Markdown and copied to clipboard.","notice-copy-fail":"Failed to copy to clipboard, please check permissions."},Z={"command-paste-name":"\u5C06\u526A\u8D34\u677F Markdown \u7C98\u8D34\u4E3A\u601D\u7EF4\u5BFC\u56FE","command-copy-name":"\u5C06 Canvas \u601D\u7EF4\u5BFC\u56FE\u5BFC\u51FA\u4E3A Markdown","setting-title":"Canvas \u601D\u7EF4\u5BFC\u56FE\u8F6C\u6362\u5668\u8BBE\u7F6E","setting-separator-name":"\u5206\u9694\u7B26","setting-separator-desc":"\u7528\u4E8E\u5C06\u526A\u8D34\u677F\u62C6\u6210\u591A\u4E2A\u8282\u70B9\u7684\u5206\u9694\u7B26\u3002\u652F\u6301 \\n\uFF08\u6362\u884C\uFF09\u3001\\n\\n\uFF08\u53CC\u6362\u884C\uFF09\u3001\\t \u7B49\u3002\u4F8B\u5982\uFF1A\\n\\n \u6216 ---","notice-open-canvas":"\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Canvas\u3002","notice-not-canvas":"\u5F53\u524D\u6807\u7B7E\u9875\u4E0D\u662F Canvas\uFF0C\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Canvas \u518D\u6267\u884C\u6B64\u547D\u4EE4\u3002","notice-read-fail":"\u65E0\u6CD5\u8BFB\u53D6\u526A\u8D34\u677F\uFF0C\u8BF7\u68C0\u67E5\u6743\u9650\u3002","notice-empty-clipboard":"\u526A\u8D34\u677F\u4E3A\u7A7A\u6216\u53EA\u6709\u7A7A\u767D\u3002","notice-parse-fail":"\u672A\u80FD\u4ECE\u526A\u8D34\u677F\u89E3\u6790\u51FA\u6709\u6548\u7684\u5C42\u7EA7\u5185\u5BB9\u3002","notice-create-success":"\u5DF2\u5728 Canvas \u4E2D\u521B\u5EFA {0} \u4E2A\u8282\u70B9\u5E76\u5EFA\u7ACB\u4E86 {1} \u6761\u8FDE\u63A5\u3002","notice-create-fail":"\u521B\u5EFA Canvas \u8282\u70B9\u5931\u8D25\uFF0C\u8BE6\u89C1\u63A7\u5236\u53F0\u3002","notice-no-nodes":"\u5F53\u524D\u753B\u5E03\u6CA1\u6709\u8282\u70B9\u3002","notice-select-at-least-one":"\u8BF7\u5148\u9009\u4E2D\u81F3\u5C11\u4E00\u4E2A\u8282\u70B9\u3002","notice-export-success":"\u5DF2\u5BFC\u51FA {0} \u4E2A\u8282\u70B9\u4E3A Markdown \u5E76\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F\u3002","notice-copy-fail":"\u590D\u5236\u5230\u526A\u8D34\u677F\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u6743\u9650\u3002"};function h(u,...l){let e=(G.moment.locale().startsWith("zh")?Z:$)[u]||$[u]||u;return l.length>0&&l.forEach((s,r)=>{e=e.replace(`{${r}}`,s)}),e}var A="\\n\\n",R=260,D=60,q=100,V=40,X=100,J=100;var z={splitSeparator:A},S=class extends N.Plugin{constructor(){super(...arguments);this.settings=z}async onload(){await this.loadSettings(),this.addCommand({id:"paste-clipboard-as-nodes",name:h("command-paste-name"),callback:()=>this.pasteClipboardAsNodes()}),this.addCommand({id:"copy-selected-canvas-nodes-as-markdown",name:h("command-copy-name"),callback:()=>this.copySelectedCanvasNodesAsMarkdown()}),this.addSettingTab(new E(this.app,this))}onunload(){}async loadSettings(){this.settings={...z,...await this.loadData()}}async saveSettings(){await this.saveData(this.settings)}resolveSeparator(t){return!t||t===A?`

`:t.replace(/\\n/g,`
`).replace(/\\t/g,"	").replace(/\\r/g,"\r")}async pasteClipboardAsNodes(){var m;let t=this.app.workspace.getLeaf(!1);if(!(t!=null&&t.view)){this.showNotice(h("notice-open-canvas"));return}let n=t.view;if(((m=n.getViewType)==null?void 0:m.call(n))!=="canvas"||!n.canvas){this.showNotice(h("notice-not-canvas"));return}let a;try{a=await navigator.clipboard.readText()}catch(c){this.showNotice(h("notice-read-fail"));return}if(!(a!=null&&a.trim())){this.showNotice(h("notice-empty-clipboard"));return}let e=this.parseMarkdownToHierarchy(a);if(e.length===0){this.showNotice(h("notice-parse-fail"));return}let s=n.canvas;this.calculateLayout(e,X,J);let r=[],o=[],p=()=>Math.random().toString(16).slice(2,10),f=(c,v)=>{for(let g of c){let d=p();g.id=d,r.push({id:d,type:"text",text:g.text,x:g.x,y:g.y,width:R,height:D}),v&&o.push({id:p(),fromNode:v,fromSide:"right",toNode:d,toSide:"left"}),f(g.children,d)}};f(e,null);try{if(typeof s.importData=="function")s.importData({nodes:r,edges:o});else{let c=s.getData();s.setData({nodes:[...c.nodes,...r],edges:[...c.edges,...o]})}this.showNotice(h("notice-create-success",String(r.length),String(o.length)))}catch(c){console.error("Failed to import canvas data:",c),this.showNotice(h("notice-create-fail"))}}parseMarkdownToHierarchy(t){let n=t.split(/\r?\n(?=#{1,6}\s+|(?:\s*[-*+]|\s*\d+\.)\s+)/),a=[],e=[];for(let s of n){let r=s.trim();if(!r)continue;let o=s.indexOf(`
`),p=o===-1?s:s.slice(0,o),f=p.trim(),m=0,c=r,v=f.match(/^(#{1,6})\s+(.*)$/);if(v){m=v[1].length;let d=o===-1?"":s.slice(o);c=v[2]+d.trimEnd()}else{let d=p.match(/^(\s*)([-*+]|\d+\.)\s+(.*)$/);if(d){let y=d[1].contains("	")?d[1].length*4:d[1].length;m=7+Math.floor(y/4);let C=o===-1?"":s.slice(o);c=d[3]+C.trimEnd()}else m=e.length>0?e[e.length-1].level+1:1,c=r}let g={text:c.trim(),level:m,children:[],x:0,y:0};for(;e.length>0&&e[e.length-1].level>=m;)e.pop();e.length===0?a.push(g):e[e.length-1].node.children.push(g),e.push({node:g,level:m})}return a}calculateLayout(t,n,a){let e=a;for(let s of t){s.x=n;let r=s.children.length>0?this.calculateLayout(s.children,n+R+q,e):D;s.y=e+(r-D)/2,e+=Math.max(D,r)+V}return e-a-V}async copySelectedCanvasNodesAsMarkdown(){var F;let t=this.app.workspace.getLeaf(!1);debugger;if(!(t!=null&&t.view)){this.showNotice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2A Canvas\u3002");return}let n=t.view;if(((F=n.getViewType)==null?void 0:F.call(n))!=="canvas"||!n.canvas){this.showNotice(h("notice-not-canvas"));return}let a=n.canvas,e=a.getData(),{nodes:s,edges:r}=e;if(!(s!=null&&s.length)){this.showNotice(h("notice-no-nodes"));return}let o=new Map;for(let i of s)o.set(i.id,i);let p,f=a.selection;if(f!=null&&f.size){p=new Set;for(let i of f){let w=i.getData();w&&!("fromNode"in w&&"toNode"in w)&&p.add(i.id)}}else p=new Set(o.keys());if(p.size===0){this.showNotice(h("notice-select-at-least-one"));return}let m=(r!=null?r:[]).filter(i=>p.has(i.fromNode)&&p.has(i.toNode)),c=new Map,v=new Set;for(let i of m)c.has(i.fromNode)||c.set(i.fromNode,[]),c.get(i.fromNode).push(i.toNode),v.add(i.toNode);let g=i=>o.get(i),d=(i,w)=>{let b=g(i),k=g(w);return!b||!k?0:b.y!==k.y?b.y-k.y:b.x-k.x},y=[...p].filter(i=>!v.has(i));y.sort(d);let C=[],x="    ",H=(i,w)=>{var _;let b=o.get(i);if(!b)return;let k=this.getCanvasNodeDisplayText(b),{title:L,rest:P}=this.getFirstParagraphAndRest(k);if(L&&(w<=6?C.push("#".repeat(w)+" "+L):C.push(x.repeat(w-7)+"- "+L)),P.trim()){let T=this.parseMarkdownToBullets(P,w-7);C.push(...T)}let O=(_=c.get(i))!=null?_:[];O.sort(d);for(let T of O)H(T,w+1)};for(let i of y)H(i,1);let I=C.join(`
`);try{await navigator.clipboard.writeText(I),this.showNotice(h("notice-export-success",String(p.size)))}catch(i){this.showNotice(h("notice-copy-fail"))}}getFirstParagraphAndRest(t){if(!(t!=null&&t.trim()))return{title:"",rest:""};let n=t.trim(),a="",e="",s=n.indexOf(`
`);return s>=0?(a=n.slice(0,s).trim(),e=n.slice(s+1).trim()):(a=n,e=""),a=a.replace(/^(#{1,6})\s+/,""),a=a.replace(/^([-*+]|\d+\.)\s+/,""),{title:a,rest:e}}parseMarkdownToBullets(t,n){let a=t.split(/\r?\n/),e=[],s="    ",r=-1,o=0,p=!1;n<0&&(n=0);for(let f of a){let m=f.trim();if(!m)continue;let c=f.match(/^(#{1,6})\s+(.*)$/);if(c){let g=c[1].length,d=c[2].trim(),y=Math.max(0,g);y-r==1?++o:o=0,r=y;let C=s.repeat(o+n)+"- "+d;e.push(C),!p&&(p=!0);continue}let v=f.match(/^(\s*)([-*+]|\d+\.)\s+(.*)$/);if(v){let g=v[1],d=v[3].trim(),y=Math.floor(g.length/4),C=n+o+y,x=s.repeat(p?C+1:C)+"- "+d;e.push(x);continue}e.push(`
- `+m)}return e}getCanvasNodeDisplayText(t){var n,a,e,s,r;switch(t.type){case"text":return((n=t.text)==null?void 0:n.trim())||"";case"file":{let o=t;return o.subpath?`[[${o.file}${o.subpath}]]`:`[[${o.file}]]`}case"link":return(a=t.url)!=null?a:"";case"group":return((e=t.label)==null?void 0:e.trim())||"Group";default:return(r=(s=t.text)==null?void 0:s.trim())!=null?r:""}}showNotice(t){new N.Notice(t)}},E=class extends N.PluginSettingTab{constructor(l,t){super(l,t),this.plugin=t}display(){let{containerEl:l}=this;l.empty(),l.createEl("h2",{text:h("setting-title")}),new N.Setting(l).setName(h("setting-separator-name")).setDesc(h("setting-separator-desc")).addText(t=>t.setPlaceholder("\\n\\n").setValue(this.plugin.settings.splitSeparator).onChange(async n=>{this.plugin.settings.splitSeparator=n||A,await this.plugin.saveSettings()}))}};
